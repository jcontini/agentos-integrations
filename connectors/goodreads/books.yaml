# Goodreads connector for Books app
# Import-only via CSV (Goodreads API was discontinued ~2020)

actions:
  import:
    # Chained executor: csv reads file, app upserts to database
    - csv:
        path: "{{params.path}}"
        response:
          mapping:
            # Source tracking
            source_connector: "'goodreads'"
            source_id: "[].'Book Id'"
            
            # Core metadata
            title: "[].'Title'"
            authors: "[].'Author' | to_array"
            isbn: "[].'ISBN' | strip_quotes"
            isbn13: "[].'ISBN13' | strip_quotes"
            
            # Personal data
            status: |
              [].'Exclusive Shelf' == 'to-read' ? 'want_to_read' :
              [].'Exclusive Shelf' == 'currently-reading' ? 'reading' :
              [].'Exclusive Shelf' == 'read' ? 'read' : 'none'
            rating: "[].'My Rating' | to_int"
            review: "[].'My Review'"
            
            # Dates
            date_added: "[].'Date Added' | replace:/:-"
            date_started: "[].'Date Read' | replace:/:-"
            date_finished: "[].'Date Read' | replace:/:-"
      as: records
    
    - app:
        action: upsert
        table: books
        on_conflict: [source_connector, source_id]
        data: "{{records}}"
