# Pre-commit: Fast validation (~1s)
# - Schema validation (catches malformed YAML)
# - Security checks (catches credential exposure)
# - Test linting (catches missing patterns)
# - Graph validation (catches broken entity references)
# Full integration tests run on pre-push

STAGED_READMES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^plugins/[^/]+/readme\.md$' || true)
STAGED_TESTS=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^plugins/[^/]+/tests/.*\.test\.ts$' || true)
STAGED_ENTITIES=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^entities/.*\.yaml$' || true)

# Nothing to check
if [ -z "$STAGED_READMES" ] && [ -z "$STAGED_TESTS" ] && [ -z "$STAGED_ENTITIES" ]; then
  exit 0
fi

ERRORS=0

# === Schema Validation (for readme changes) ===
if [ -n "$STAGED_READMES" ]; then
  echo "üìã Schema validation..."
  APPS=$(echo "$STAGED_READMES" | sed 's|plugins/||' | sed 's|/readme.md||' | tr '\n' ' ')
  node tests/plugins/scripts/validate.mjs $APPS --no-move || ERRORS=$((ERRORS + 1))
  echo ""
fi

# === Security Checks (for readme changes) ===
if [ -n "$STAGED_READMES" ]; then
  echo "üîí Security checks..."

  # Check for credential exposure patterns
  if echo "$STAGED_READMES" | xargs grep -l '\$AUTH_TOKEN\|\${AUTH_TOKEN}' 2>/dev/null; then
    echo "‚ùå BLOCKED: \$AUTH_TOKEN found - use rest: or graphql: blocks instead"
    ERRORS=$((ERRORS + 1))
  fi

  if echo "$STAGED_READMES" | xargs grep -l 'curl.*[Aa]uthorization\|wget' 2>/dev/null; then
    echo "‚ùå BLOCKED: curl/wget with auth - use AgentOS executors (rest:, graphql:, sql:)"
    ERRORS=$((ERRORS + 1))
  fi

  if echo "$STAGED_READMES" | xargs grep -l 'Bearer \$' 2>/dev/null; then
    echo "‚ùå BLOCKED: Bearer token interpolation - AgentOS handles auth automatically"
    ERRORS=$((ERRORS + 1))
  fi
  echo ""
fi

# === Test Linting (for test file or readme changes) ===
# Lint tests when either test files or readmes change (readmes affect test requirements)
if [ -n "$STAGED_TESTS" ] || [ -n "$STAGED_READMES" ]; then
  echo "üß™ Test linting..."
  
  # Get unique plugin names from both staged tests and readmes
  PLUGINS=""
  if [ -n "$STAGED_TESTS" ]; then
    PLUGINS="$PLUGINS $(echo "$STAGED_TESTS" | sed 's|plugins/||' | sed 's|/tests/.*||' | sort -u | tr '\n' ' ')"
  fi
  if [ -n "$STAGED_READMES" ]; then
    PLUGINS="$PLUGINS $(echo "$STAGED_READMES" | sed 's|plugins/||' | sed 's|/readme.md||' | sort -u | tr '\n' ' ')"
  fi
  PLUGINS=$(echo "$PLUGINS" | tr ' ' '\n' | sort -u | tr '\n' ' ')
  
  npx tsx tests/plugins/scripts/lint-tests.ts $PLUGINS || ERRORS=$((ERRORS + 1))
  echo ""
fi

# === Graph Validation (for entity changes) ===
if [ -n "$STAGED_ENTITIES" ]; then
  echo "üîó Graph validation..."
  node tests/entities/scripts/validate-graph.mjs || ERRORS=$((ERRORS + 1))
  echo ""
fi

if [ $ERRORS -eq 0 ]; then
  echo "‚úÖ All checks passed"
else
  echo "‚ùå Fix $ERRORS error(s) before committing"
  exit 1
fi
